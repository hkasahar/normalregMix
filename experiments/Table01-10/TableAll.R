### UTILITIES
## Generates EM test result according to the dimension of X
PerformEMtest <- function (sample, q, m = 1, z = NULL, parallel.method) {
  library(doParallel) # workers might need information
  library(normalregMix2Test)  # workers might need information

	n <- as.integer(length(sample)/(q+1))
  y <- sample[1:n] # first n elements represents y data
  if (q <= 0)
    return (normalmixMEMtest(y, m = m, z = z, crit.method = "asy",
														 parallel.method = parallel.method))
  # the other part consists of n chuck of q-length x data
  x <- matrix(sample[(n+1):length(sample)], nrow = n, byrow = TRUE)
  return (regmixMEMtest(y, x, m = m, z = z, crit.method = "asy",
                        parallel.method =  parallel.method))
}

## Returns frequency that the null H0: m=1 is rejected
# out of replications of given an and data that consists of columns of samples
PerformEMtests <- function (data, crit = 0.05, q = 1, m = 1,
                            parallel.method = "none", rmpi = TRUE) {
  if (rmpi)
  {
    # need to transform data (matrix) to a list first; each element is a column (y x_1' x_2' ... x_n')'
    ldata <- lapply(seq_len(ncol(data)), function(i) data[,i])
    out  <- mpi.applyLB(ldata, PerformEMtest, q = q, m = m, z = NULL,
                        parallel.method = parallel.method)
  }
  else
    out <- apply(data, 2, PerformEMtest, q = q, m = m, z = NULL,
                 parallel.method = parallel.method)
  pvals <- sapply(out, "[[", "pvals")
  return (list(K1 = mean(pvals[1,] < crit),
							 K2 = mean(pvals[2,] < crit),
							 K3 = mean(pvals[3,] < crit)))
}

# Generate a column that represents a sample using phi given.
GenerateSample <- function(phi){
  n				<- phi$n
  alpha   <- phi$alphaset
  mus 	  <- phi$muset
  sigmas  <- phi$sigmaset
  betaset <- 0
  q       <- 0
  sample.x <- rep(0,n)
  if (!is.null(phi$betaset))
  {
    betaset <- phi$betaset
    q <- length(betaset[[1]])
    sample.x <- matrix(rnorm(n*q), nrow = n) # each row is one observation
  }
  m       <- length(alpha)
  alpha_cumsum <- cumsum(alpha)

  sample.y <- vector(mode = "double", n)

  for (i in 1:n)
  {
    prob <- runif(1)
    index <- 1
    for (j in 2:m)
      if (prob > alpha_cumsum[j-1] && prob <= alpha_cumsum[j])
        index = j
    sample.y[i] <- rnorm(1, mean = (mus[index] + betaset*sample.x[i,]),
                            sd = sigmas[index])
  }

  if (q > 0)
    return (rbind(y.sample, (t(x.sample))))
  return(y.sample)
}


## Generate a pair of phi and data, where data is generated by replication.
GeneratePhiDataPair <- function(phi, replication) {
	phi <- as.list(phi) # make it atomic.
  # data is an (n replication) matrix whose column represents a sample of size n,
  data <- do.call(cbind, replicate(replication, GenerateSample(phi = phi), simplify = FALSE))
  return (list(phi = phi, data = data))
}

## Create data given phiset and replication
GeneratePhiDataPairs <- function(phiset, replication = 5000) {
	apply(phiset, 1, GeneratePhiDataPair, replication = replication) # list of (phi data)
}

## Returns a list of phis given musets,  sigmasets,  alphasets, nset, betasets
CreatePhiSet <- function(musets, sigmasets, alphasets, nset, betasets = NULL) {
	expand.grid(muset = musets, sigmaset = sigmasets, alphaset = alphasets,
							betaset = betasets, n = nset)
}

### EXPERIMENT
## Rmpi setup
print("collecting workers..")
    mpi.spawn.Rslaves()
    mpi.setup.rngstream()
    mpi.bcast.Robj2slave(PerformEMtest, all=TRUE)
print("workers loaded.")
set.seed(123456)
## ====== BEGIN EXPERIMENT ======
## 1. Initialization & data generation
# Table 02
musets <- list(c(-2.0, 0, 2.0), c(-1.0, 0, 3.0))
sigmasets <- list(c(0.6, 1.2, 0.6))
alphasets <- list(c(1/3, 1/3, 1/3), c(0.4, 0.2, 0.4))
phi1 <- CreatePhiSet(musets, sigmasets, alphasets, nset = 200)
phi2 <- CreatePhiSet(musets, sigmasets, alphasets, nset = 400)
table02.pairs <- GeneratePhiDataPairs(append(phi1, phi2))

# Table 03
musets <- list(c(-4.5,-1.5, 1.5, 4.5), c(-6,-2, 2, 6),
							 c(-4.0,-1.25, 1.25, 4.0), c(-3.5,-1.5, 1.5, 5.0))
sigmasets <- list(c(1, 1, 1, 1), c(0.6, 1.2, 0.6, 1.2),
									c(0.6, 0.8, 1.0, 1.2), c(0.8, 0.8, 0.8, 1.2))
alphasets <- list(rep(1/4, 4))
nset <- c(200, 400)
table03.pairs <- GeneratePhiDataPairs(
									CreatePhiSet(musets, sigmasets, alphasets, nset))

# Table 05 & 06
# TODO: (need extra attention, dim(X) = 1, 2, 3, 4)
musets <- list(c(-1.15, 1.15), c(-0.75, 0.75))
sigmasets <- list(c(1.0, 1.0), c(1.2, 0.8))
alphasets <- list(c(0.5, 0.5), c(0.25, 0.75))
betasets <- list(c(0.5, 0.5), c(-0.25, 0.25))
table06.pairs <- GeneratePhiDataPairs(CreatePhiSet(musets, sigmasets, alphasets,
																			nset, betasets = betasets))


# Table 08 (replication = 199)
A <- c(-2.5, 0, 2.5)
B <- c(-2.0, 0, 4.0)
C <- c(1/3, 1/3, 1/3)
D <- c(0.4, 0.2, 0.4)
musets <- list(A, B)
sigmasets <- list(c(1, 1, 1))
alphasets <- list(C, D)
betasets <- list(c(-0.5, 0, 0.5))
nset <- c(200, 400)
table08.pairs <- GeneratePhiDataPairs(CreatePhiSet(musets, sigmasets, alphasets,
																			nset, betasets = betasets))

# Table 09 (replication = 199)
A <- c(-4.5, -1.5, 1.5, 4.5)
B <- c(-4.0, -1.25, 1.25, 4.0)
C <- c(-0.75, -0.25, 0.25, -0.75)
D <- c(-1.5, -0.5, 0.5, 1.5)
E <- c(1, 1, 1, 1)
F <- c(0.6, 1.2, 0.6, 1.2)
alphasets <- list(c(0.25, 0.25, 0.25, 0.25))
betasets <- list(C, D)
nset <- list(200, 400)
musets <- list(A)
sigmasets <- list(E)
phiset1 <- CreatePhiSet(musets, sigmasets, alphasets, nset, betasets = betasets)
musets <- list(B)
sigmasets <- list(F)
phiset2 <- CreatePhiSet(musets, sigmasets, alphasets, nset, betasets = betasets)
table09.pairs <- GeneratePhiDataPairs(append(phiset1, phiset2), replication = 199)

## 2. Tables
GenerateTable02 <- function(pairs)
	rows <- list()
	for (i in 1:length(pairs)) {
		phi <- pairs[[i]]$phi
		data <- pairs[[i]]$data
		m <- length(phi$alphaset)
		q <- length(phi$betaset)
		rejection.rates <- normalmixMEMtest(data, q = q, m = m)
		rows[[i]] <- list(phi$muset, phi$sigmaset, phi$alphaset,
											phi$n, rejection.rates)
		df <- data.frame(matrix(unlist(regdata), ncol = length(regdata[[1]]), byrow=T))
		colnames(df) <- c("muset", "sigmaset", "alphaset",
											"n", "rejection.rates")
		print(df) # save every time
	}
	print("Table 02:")
	print(df)
}
GenerateTable02(table02.pairs)

## TODO: Finish other tables. Table 03-07 have similar structures.
## ====== END EXPERIMENT ======
# Rmpi termination
    mpi.close.Rslaves()
